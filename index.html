<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Wound Vac Tracker (PHI-Free)</title>

  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; margin:0; background:#0b0c10; color:#e8e8e8; }
    .wrap { padding: 16px; max-width: 520px; margin: 0 auto; }
    .card { background:#151823; border:1px solid #2a2f45; border-radius:14px; padding:14px; margin: 12px 0; }
    .btn { width:100%; padding:14px 14px; border-radius:12px; border:0; background:#2f7dff; color:white; font-weight:700; font-size:16px; }
    .btn:disabled { opacity:.5; }
    label { display:block; font-size:13px; opacity:.9; margin:10px 0 6px; }
    input { width:100%; padding:12px; border-radius:10px; border:1px solid #2a2f45; background:#0f1220; color:#e8e8e8; font-size:16px; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    .muted { opacity:.75; font-size:13px; line-height:1.35; }

    /* Scanner + success overlay */
    #reader { width:100%; border-radius: 12px; overflow:hidden; }
    .status {
      display:flex; align-items:center; justify-content:center;
      gap:10px; padding:10px; border-radius:12px; font-weight:800;
      border:1px solid #2a2f45; background:#0f1220;
      margin-top:12px;
      min-height:46px;
    }
    .status.success { border-color:#2ecc71; background: rgba(46,204,113,.12); }
    .status.error   { border-color:#ff4d4d; background: rgba(255,77,77,.10); }
    .check {
      width:26px; height:26px; border-radius:999px; display:inline-flex;
      align-items:center; justify-content:center; font-size:18px;
      border:2px solid currentColor;
    }
    .success .check { color:#2ecc71; }
    .error .check { color:#ff4d4d; }
    .hidden { display:none; }

    /* iOS-friendly toast overlay */
    .toast {
      position:fixed; left:50%; top:16px; transform:translateX(-50%);
      padding:10px 14px; border-radius:999px;
      border:1px solid #2a2f45; background:#151823; color:#e8e8e8;
      font-weight:800; z-index:9999;
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
      opacity:0; pointer-events:none; transition:opacity .18s ease;
      max-width: 90%;
      text-align:center;
    }
    .toast.show { opacity:1; }
    .toast.success { border-color:#2ecc71; background: rgba(46,204,113,.15); }
    .toast.error   { border-color:#ff4d4d; background: rgba(255,77,77,.12); }
  </style>

  <!-- html5-qrcode (scanner library) -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>
  <div class="wrap">
    <h2 style="margin:10px 0 0;">Wound Vac Tracker</h2>
    <div class="muted">PHI-free device log (serial + location). No patient names, MRNs, or DOBs.</div>

    <div class="card">
      <button id="startBtn" class="btn">Start Scan</button>
      <div style="height:10px;"></div>
      <div id="reader" class="hidden"></div>

      <div id="status" class="status hidden">
        <span class="check">✓</span>
        <span id="statusText">Code accepted</span>
      </div>

      <div class="muted" style="margin-top:10px;">
        Tip: If scanning is finicky, use manual entry below.
      </div>
    </div>

    <div class="card">
      <label>Serial Number (from scan or manual)</label>
      <input id="serial" placeholder="e.g., KCI-123456789" autocomplete="off" inputmode="latin" />

      <div class="row">
        <div>
          <label>Unit</label>
          <input id="unit" placeholder="e.g., 5N" autocomplete="off" />
        </div>
        <div>
          <label>Room</label>
          <input id="room" placeholder="e.g., 512" autocomplete="off" inputmode="numeric" />
        </div>
        <div>
          <label>Bed</label>
          <input id="bed" placeholder="A/B" autocomplete="off" />
        </div>
      </div>

      <label>Logged by (initials or role)</label>
      <input id="by" placeholder="e.g., AD / Central Supply" autocomplete="off" />

      <div style="height:12px;"></div>
      <button id="saveBtn" class="btn">Save Log</button>
      <div class="muted" style="margin-top:10px;">Saved locally on this device (no cloud yet).</div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">Recent Logs</h3>
      <div id="list" class="muted">No logs yet.</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  // ====== SETTINGS ======
  // Accept patterns like:
  // - "KCI-123456"
  // - "1234567890"
  // - "VAC:ABC12345"
  // Tweak to your reality once you confirm what the QR actually returns.
  const ALLOWED = /^[A-Za-z0-9:\-]{6,40}$/;

  // ====== UI HELPERS ======
  const $ = (id) => document.getElementById(id);
  const toastEl = $("toast");
  const statusEl = $("status");
  const statusText = $("statusText");

  function showToast(msg, kind="success") {
    toastEl.textContent = msg;
    toastEl.className = `toast show ${kind}`;
    setTimeout(() => toastEl.classList.remove("show"), 1100);
  }

  function setStatus(kind, msg) {
    statusEl.classList.remove("hidden", "success", "error");
    statusEl.classList.add(kind);
    statusText.textContent = msg;
  }

  function hideStatus() {
    statusEl.classList.add("hidden");
    statusEl.classList.remove("success","error");
  }

  function vibrateOk() {
    if (navigator.vibrate) navigator.vibrate(60);
  }

  // ====== STORAGE ======
  const KEY = "woundvac_logs_v1";
  function loadLogs() {
    try { return JSON.parse(localStorage.getItem(KEY) || "[]"); } catch { return []; }
  }
  function saveLogs(logs) {
    localStorage.setItem(KEY, JSON.stringify(logs));
  }
  function renderLogs() {
    const logs = loadLogs().slice().reverse().slice(0, 20);
    if (!logs.length) { $("list").textContent = "No logs yet."; return; }
    $("list").innerHTML = logs.map(l => {
      const when = new Date(l.ts).toLocaleString();
      return `<div style="padding:10px 0;border-top:1px solid #2a2f45">
        <div><b>${escapeHtml(l.serial)}</b></div>
        <div>${escapeHtml(l.unit)} / Room ${escapeHtml(l.room)} / Bed ${escapeHtml(l.bed)}</div>
        <div style="opacity:.8">${when} — ${escapeHtml(l.by)}</div>
      </div>`;
    }).join("");
  }
  function escapeHtml(s="") {
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  // ====== SCANNER ======
  let html5Qr = null;
  let scanning = false;

  async function startScan() {
    if (scanning) return;

    // IMPORTANT: iOS requires HTTPS (or localhost) for camera
    $("reader").classList.remove("hidden");
    hideStatus();

    html5Qr = html5Qr || new Html5Qrcode("reader");

    const config = {
      fps: 10,
      qrbox: { width: 240, height: 240 },
      rememberLastUsedCamera: true,
      formatsToSupport: [
        Html5QrcodeSupportedFormats.QR_CODE,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.CODE_39,
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.UPC_E
      ]
    };

    scanning = true;
    $("startBtn").disabled = true;
    $("startBtn").textContent = "Scanning…";

    try {
      await html5Qr.start(
        { facingMode: "environment" },
        config,
        (decodedText) => onScan(decodedText),
        () => { /* ignore per-frame errors */ }
      );
    } catch (e) {
      scanning = false;
      $("startBtn").disabled = false;
      $("startBtn").textContent = "Start Scan";
      setStatus("error", "Camera error — try again or use manual entry.");
      showToast("Camera error", "error");
      console.error(e);
    }
  }

  async function stopScan() {
    if (!html5Qr || !scanning) return;
    scanning = false;
    try { await html5Qr.stop(); } catch {}
    $("startBtn").disabled = false;
    $("startBtn").textContent = "Start Scan";
  }

  async function onScan(text) {
    const cleaned = String(text || "").trim();

    // Validate
    if (!cleaned || !ALLOWED.test(cleaned)) {
      setStatus("error", "Invalid code — try again.");
      showToast("Invalid code", "error");
      return;
    }

    // ✅ SUCCESS UX
    $("serial").value = cleaned;
    setStatus("success", "Code accepted");
    showToast("Code accepted ✅", "success");
    vibrateOk();

    // Pause scanning so it doesn’t keep firing
    await stopScan();

    // Small delay so the user *sees* the green check, then jump them forward
    setTimeout(() => {
      $("unit").focus();
    }, 650);
  }

  // ====== SAVE LOG ======
  $("saveBtn").addEventListener("click", () => {
    const serial = $("serial").value.trim();
    const unit = $("unit").value.trim();
    const room = $("room").value.trim();
    const bed  = $("bed").value.trim();
    const by   = $("by").value.trim() || "Staff";

    if (!serial || !ALLOWED.test(serial)) {
      showToast("Enter a valid serial", "error");
      setStatus("error", "Enter a valid serial number.");
      return;
    }
    if (!unit || !room || !bed) {
      showToast("Add Unit/Room/Bed", "error");
      setStatus("error", "Please complete Unit / Room / Bed.");
      return;
    }

    const logs = loadLogs();
    logs.push({ serial, unit, room, bed, by, ts: Date.now() });
    saveLogs(logs);

    showToast("Saved ✅", "success");
    setStatus("success", "Saved");
    renderLogs();

    // Optional: clear fields except Unit (often same area)
    $("serial").value = "";
    $("room").value = "";
    $("bed").value = "";
  });

  $("startBtn").addEventListener("click", startScan);
  renderLogs();
</script>

</body>
</html>
